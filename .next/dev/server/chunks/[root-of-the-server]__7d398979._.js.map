{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/marienel/Downloads/clinic-management-system/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\r\n\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient }\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ||\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\r\n  })\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\r\n\r\nexport default prisma\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG;uCAErD"}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/marienel/Downloads/clinic-management-system/app/api/patients/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport prisma from '@/lib/db'\r\n\r\n// ======= Validation Helpers =======\r\nconst validateNameField = (name: string): boolean =>\r\n  !!name?.trim() && /^[a-zA-Z\\s]*$/.test(name.trim())\r\n\r\nconst validatePhone = (phone: string): boolean =>\r\n  typeof phone === 'string' && /^09\\d{9}$/.test(phone)\r\n\r\nconst validateIdNumber = (idNumber: string): boolean =>\r\n  typeof idNumber === 'string' && /^[a-zA-Z0-9-]+$/.test(idNumber)\r\n\r\nconst parseAttachments = (attachments: any) => {\r\n  if (!attachments) return null\r\n  try {\r\n    return JSON.stringify(attachments)\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n// ======= GET - All patients =======\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const userId = request.headers.get('x-user-id')\r\n    if (!userId) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    const patients = await prisma.patient.findMany({\r\n      where: { userId },\r\n      orderBy: { createdAt: 'desc' },\r\n    })\r\n\r\n    return NextResponse.json({ patients })\r\n  } catch (error) {\r\n    console.error('Get patients error:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to fetch patients' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// ======= POST - Create patient =======\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const userId = request.headers.get('x-user-id')\r\n    if (!userId) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    const data = await request.json()\r\n    const errors: string[] = []\r\n\r\n    // ===== Basic validations =====\r\n    if (!validateNameField(data.firstName)) errors.push('First name is required and must be letters only')\r\n    if (data.middleName && !validateNameField(data.middleName)) errors.push('Middle name must contain letters only')\r\n    if (!validateNameField(data.lastName)) errors.push('Last name is required and must be letters only')\r\n    if (data.suffix && !validateNameField(data.suffix)) errors.push('Suffix must contain letters only')\r\n\r\n    if (!data.dateOfBirth) errors.push('Date of birth is required')\r\n    if (isNaN(Date.parse(data.dateOfBirth))) errors.push('Invalid date of birth')\r\n\r\n    if (!data.gender) errors.push('Gender is required')\r\n    if (!validatePhone(data.phone)) errors.push('Phone must start with 09 and be exactly 11 digits')\r\n\r\n    if (!data.role || !['student', 'teaching_staff', 'non_teaching_staff'].includes(data.role)) {\r\n      errors.push('Valid role is required')\r\n    }\r\n\r\n    if (!validateIdNumber(data.idNumber)) errors.push('Valid ID number is required')\r\n\r\n    // ===== Role-specific =====\r\n    if (data.role === 'student') {\r\n      if (!['CICT', 'CBME'].includes(data.program)) errors.push('Valid program is required for students')\r\n      if (!data.course) errors.push('Course is required for students')\r\n      if (!data.yearLevel || data.yearLevel < 1 || data.yearLevel > 4) errors.push('Year level must be 1â€“4')\r\n      if (data.block && (data.block < 1 || data.block > 5)) errors.push('Block must be 1â€“5')\r\n    }\r\n\r\n    if (data.role === 'teaching_staff') {\r\n      if (!['CICT', 'CBME'].includes(data.department)) errors.push('Valid department is required')\r\n    }\r\n\r\n    if (data.role === 'non_teaching_staff') {\r\n      if (!data.staffCategory) errors.push('Staff category is required')\r\n    }\r\n\r\n    // ===== Emergency contact =====\r\n    if (!data.primaryContactName?.trim()) errors.push('Primary contact name is required')\r\n    if (!data.primaryContactRelationship?.trim()) errors.push('Primary contact relationship is required')\r\n    if (!validatePhone(data.primaryContactPhone)) errors.push('Primary contact phone is invalid')\r\n\r\n    if (errors.length > 0) {\r\n      return NextResponse.json({ errors }, { status: 400 })\r\n    }\r\n\r\n    // ===== CREATE =====\r\n    const patient = await prisma.patient.create({\r\n      data: {\r\n        ...data,\r\n        dateOfBirth: new Date(data.dateOfBirth), // ðŸ”¥ FIX\r\n        middleName: data.middleName || null,\r\n        suffix: data.suffix || null,\r\n        email: data.email || null,\r\n        address: data.address || null,\r\n        program: data.role === 'student' ? data.program : null,\r\n        course: data.role === 'student' ? data.course : null,\r\n        yearLevel: data.role === 'student' ? data.yearLevel : null,\r\n        block: data.role === 'student' ? data.block : null,\r\n        department: data.role === 'teaching_staff' ? data.department : null,\r\n        staffCategory: data.role === 'non_teaching_staff' ? data.staffCategory : null,\r\n        pastIllnesses: data.pastIllnesses || null,\r\n        surgeries: data.surgeries || null,\r\n        currentMedication: data.currentMedication || null,\r\n        allergies: data.allergies || null,\r\n        medicalNotes: data.medicalNotes || null,\r\n        primaryContactAddress: data.primaryContactAddress || null,\r\n        secondaryContactName: data.secondaryContactName || null,\r\n        secondaryContactRelationship: data.secondaryContactRelationship || null,\r\n        secondaryContactPhone: data.secondaryContactPhone || null,\r\n        secondaryContactAddress: data.secondaryContactAddress || null,\r\n        attachments: parseAttachments(data.attachments),\r\n        userId,\r\n      },\r\n    })\r\n\r\n    return NextResponse.json({ patient }, { status: 201 })\r\n  } catch (error: any) {\r\n    console.error('Create patient error:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to save patient', details: error.message },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}